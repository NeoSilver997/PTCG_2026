generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ProductType {
  id        String    @id @default(cuid())
  code      String    @unique
  nameJa    String
  nameZh    String
  nameEn    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]

  @@map("product_types")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  image       String?
  role        UserRole     @default(USER)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  collections Collection[]
  decks       Deck[]
  sessions    Session[]

  @@index([email])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model PrimaryExpansion {
  id                 String              @id @default(cuid())
  code               String              @unique
  nameEn             String
  releaseDate        DateTime?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  primaryCards       PrimaryCard[]
  regionalExpansions RegionalExpansion[]

  @@index([code])
  @@map("primary_expansions")
}

model RegionalExpansion {
  id                 String           @id @default(cuid())
  primaryExpansionId String
  region             Region
  code               String
  name               String
  createdAt          DateTime         @default(now())
  cards              Card[]
  primaryExpansion   PrimaryExpansion @relation(fields: [primaryExpansionId], references: [id], onDelete: Cascade)

  @@unique([primaryExpansionId, region])
  @@index([region, code])
  @@map("regional_expansions")
}

model PrimaryCard {
  id                 String            @id @default(cuid())
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  name               String
  skillsSignature    String
  cardNumber         String?
  primaryExpansionId String?
  cards              Card[]
  primaryExpansion   PrimaryExpansion? @relation(fields: [primaryExpansionId], references: [id])

  @@unique([name, skillsSignature])
  @@index([name])
  @@index([primaryExpansionId])
  @@map("primary_cards")
}

model Card {
  id                  String             @id @default(cuid())
  primaryCardId       String
  webCardId           String             @unique
  language            LanguageCode
  variantType         VariantType        @default(NORMAL)
  name                String
  supertype           Supertype?
  subtypes            Subtype[]
  hp                  Int?
  types               PokemonType[]
  ruleBox             RuleBox?
  abilities           Json?
  attacks             Json?
  rules               String[]
  flavorText          String?
  artist              String?
  rarity              Rarity?
  regulationMark      String?
  imageUrl            String?
  imageUrlHiRes       String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  evolutionStage      EvolutionStage?
  text                String?
  regionalExpansionId String?
  evolvesFrom         String?
  evolvesTo           String?
  sourceUrl           String?
  prices              CardPrice[]
  primaryCard         PrimaryCard        @relation(fields: [primaryCardId], references: [id], onDelete: Cascade)
  regionalExpansion   RegionalExpansion? @relation(fields: [regionalExpansionId], references: [id])
  collectionItems     CollectionItem[]
  deckCards           DeckCard[]

  @@index([language])
  @@index([name])
  @@index([supertype])
  @@index([primaryCardId, language, variantType])
  @@index([regionalExpansionId])
  @@map("cards")
}

model Collection {
  id        String           @id @default(cuid())
  userId    String
  name      String           @default("My Collection")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  items     CollectionItem[]
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("collections")
}

model CollectionItem {
  id           String     @id @default(cuid())
  collectionId String
  cardId       String
  quantity     Int        @default(1)
  condition    String?
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  card         Card       @relation(fields: [cardId], references: [id], onDelete: Cascade)
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([collectionId, cardId])
  @@index([collectionId])
  @@index([cardId])
  @@map("collection_items")
}

model Tournament {
  id          String             @id @default(cuid())
  eventId     String             @unique
  name        String
  type        TournamentType
  date        DateTime
  location    String?
  region      Region
  playerCount Int?
  ageGroup    String?
  sourceUrl   String
  scrapedAt   DateTime           @default(now())
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  results     TournamentResult[]

  @@index([date])
  @@index([region, type])
  @@index([eventId])
  @@map("tournaments")
}

model TournamentResult {
  id            String         @id @default(cuid())
  tournamentId  String
  playerName    String
  placement     Int
  deckName      String?
  deckArchetype DeckArchetype?
  createdAt     DateTime       @default(now())
  deckId        String?
  deck          Deck?          @relation(fields: [deckId], references: [id])
  tournament    Tournament     @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, placement])
  @@index([tournamentId])
  @@index([playerName])
  @@map("tournament_results")
}

model Deck {
  id                 String             @id @default(cuid())
  userId             String?
  name               String
  description        String?
  archetype          DeckArchetype?
  format             String?
  isPublic           Boolean            @default(false)
  tournamentResultId String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  cards              DeckCard[]
  user               User?              @relation(fields: [userId], references: [id], onDelete: Cascade)
  tournamentResults  TournamentResult[]

  @@index([userId])
  @@index([archetype])
  @@index([isPublic])
  @@map("decks")
}

model DeckCard {
  id        String   @id @default(cuid())
  deckId    String
  cardId    String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  card      Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  deck      Deck     @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@unique([deckId, cardId])
  @@index([deckId])
  @@index([cardId])
  @@map("deck_cards")
}

model CardPrice {
  id        String      @id @default(cuid())
  cardId    String
  source    PriceSource
  condition String?
  price     Float
  currency  String      @default("JPY")
  inStock   Boolean     @default(true)
  fetchedAt DateTime    @default(now())
  createdAt DateTime    @default(now())
  card      Card        @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId, source])
  @@index([fetchedAt])
  @@map("card_prices")
}

model PriceHistory {
  id       String      @id @default(cuid())
  cardId   String
  source   PriceSource
  price    Float
  currency String      @default("JPY")
  date     DateTime    @default(now())

  @@index([cardId, source, date])
  @@map("price_history")
}

model ScraperJob {
  id           String        @id @default(cuid())
  source       Region
  status       ScraperStatus @default(PENDING)
  startedAt    DateTime?
  completedAt  DateTime?
  successCount Int           @default(0)
  failureCount Int           @default(0)
  errors       Json?
  createdAt    DateTime      @default(now())

  @@index([source, status])
  @@index([createdAt])
  @@map("scraper_jobs")
}

model Product {
  id                String       @id @default(cuid())
  country           String
  productName       String
  price             String?
  releaseDate       String?
  code              String?
  link              String?
  imageUrl          String?
  include           String?
  cardOnly          String?
  beginnerFlag      Int          @default(0)
  storesAvailable   String?
  linkCardList      String?
  linkPokemonCenter String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  productTypeId     String?
  productType       ProductType? @relation(fields: [productTypeId], references: [id])

  @@unique([country, code, productName, releaseDate])
  @@index([country])
  @@index([releaseDate])
  @@index([code])
  @@index([productTypeId])
  @@map("products")
}

enum UserRole {
  GUEST
  USER
  ADMIN
}

enum LanguageCode {
  JA_JP
  ZH_TW
  EN_US
}

enum Supertype {
  POKEMON
  TRAINER
  ENERGY
}

enum PokemonType {
  COLORLESS
  DARKNESS
  DRAGON
  FAIRY
  FIGHTING
  FIRE
  GRASS
  LIGHTNING
  METAL
  PSYCHIC
  WATER
}

enum Subtype {
  ITEM
  SUPPORTER
  STADIUM
  TOOL
  BASIC_ENERGY
  SPECIAL_ENERGY
  TERA
}

enum EvolutionStage {
  BASIC
  STAGE_1
  STAGE_2
}

enum RuleBox {
  EX
  GX
  V
  VMAX
  VSTAR
  RADIANT
  MEGA
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  DOUBLE_RARE
  ULTRA_RARE
  ILLUSTRATION_RARE
  SPECIAL_ILLUSTRATION_RARE
  HYPER_RARE
  PROMO
  AMAZING_RARE
  SHINY_RARE
  ACE_SPEC
}

enum VariantType {
  NORMAL
  REVERSE_HOLO
  HOLO
  FULL_ART
  SECRET_RARE
  PROMO
  AR
  SAR
  SSR
  SR
  UR
  MUR
  MA
  CHR
  U
  BWR
  ACE
  R
  C
}

enum Region {
  HK
  JP
  EN
}

enum TournamentType {
  CHAMPIONSHIP
  REGIONAL
  SPECIAL_EVENT
  STORE_TOURNAMENT
  ONLINE_EVENT
}

enum DeckArchetype {
  AGGRO
  CONTROL
  COMBO
  MIDRANGE
  TOOLBOX
  OTHER
}

enum PriceSource {
  YUYU_TEI
  HARERUYA
  CARDMARKET
  TCGPLAYER
  OTHER
}

enum ScraperStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}
